{% extends 'base.html' %}
{% block content %}
<section class="max-w-5xl mx-auto space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-semibold">üåç Public Roasts</h1>
      <p class="text-slate-400 text-sm">Check out roasts from users around the site</p>
    </div>
  </div>

  <div id="public-roasts-list" class="grid md:grid-cols-2 gap-4">
    <div class="col-span-2 text-center py-8 text-slate-400">Loading roasts...</div>
  </div>

  <div id="load-more" class="text-center hidden">
    <button class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded">Load More</button>
  </div>
</section>

<script>
  let currentPage = 1;

  async function loadPublicRoasts(page = 1) {
    try {
      const res = await fetch(`/api/roast/public?page=${page}`);
      const data = await res.json();

      const container = document.getElementById('public-roasts-list');

      if (page === 1) {
        container.innerHTML = '';
      }

      if (!data.roasts.length && page === 1) {
        container.innerHTML = '<div class="col-span-2 text-center py-8 text-slate-400">No public roasts yet. Be the first!</div>';
        return;
      }

      data.roasts.forEach(roast => {
        const card = document.createElement('div');
        card.className = 'bg-slate-800/50 p-4 rounded border border-slate-700 hover:border-pink-500 transition';
        card.innerHTML = `
        <div class="flex items-start justify-between mb-2">
          <div class="flex items-center gap-2">
            ${roast.user?.picture ? `<img src="${roast.user.picture}" class="w-6 h-6 rounded-full" />` : ''}
            <span class="text-sm font-medium">${roast.user?.name || 'Anonymous'}</span>
          </div>
          <span class="text-xs text-slate-500">${formatDate(roast.timestamp)}</span>
        </div>
        <p class="text-sm text-slate-300 mb-2 line-clamp-3">${roast.roast}</p>
        <div class="flex gap-2 text-xs text-slate-500">
          ${roast.sources?.map(s => `<span class="px-2 py-0.5 bg-slate-900 rounded">${s}</span>`).join('') || ''}
        </div>
        <a href="/?share=${roast.id}" class="text-xs text-pink-400 hover:underline mt-2 inline-block">View Full Roast ‚Üí</a>
      `;
        container.appendChild(card);
      });

      const loadMoreBtn = document.getElementById('load-more');
      if (data.page < data.pages) {
        loadMoreBtn.classList.remove('hidden');
        loadMoreBtn.querySelector('button').onclick = () => {
          currentPage++;
          loadPublicRoasts(currentPage);
        };
      } else {
        loadMoreBtn.classList.add('hidden');
      }
    } catch (err) {
      console.error('Failed to load public roasts:', err);
    }
  }

  function formatDate(iso) {
    const date = new Date(iso);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
  }

  loadPublicRoasts();
</script>
{% endblock %}
